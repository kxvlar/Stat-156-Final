---
title: "Doubly Robust"
format: html
---





```{r}
library(dplyr)
library(tidyr)

run_dr_att <- function(df,
                       outcome_var = "taltb",
                       treat_var   = "temp",
                       covars,
                       B    = 300,
                       seed = 156,
                       ps_trim = c(0.01, 0.99)) {
  # 1. Main analysis sample (same as IPW pipeline)
  dat <- make_ipw_sample3(df)
  
  # 2. Build outcome (same definition as for IPW)
  dat$y401k_ipw <- make_ipw_outcome3(dat, outcome_var)
  
  # 3. Check covariates exist
  missing_covars <- setdiff(covars, names(dat))
  if (length(missing_covars) > 0) {
    stop(
      "These covariates are not in the data: ",
      paste(missing_covars, collapse = ", ")
    )
  }
  
  # 4. Filter to complete cases in treatment, outcome, and covariates
  dat_complete <- dat %>%
    filter(
      !is.na(.data[[treat_var]]),
      !is.na(y401k_ipw)
    ) %>%
    tidyr::drop_na(all_of(covars))
  
  if (nrow(dat_complete) == 0) {
    stop(
      "After filtering for non-missing treatment, outcome, and covariates, ",
      "no observations remain."
    )
  }
  
  # Rename for convenience
  Z <- dat_complete[[treat_var]]   # 1 = treated (temp), 0 = control
  Y <- dat_complete$y401k_ipw
  
  # 5. Propensity score model (same as before, tage + tage^2 + others)
  rhs_terms  <- c("tage", "I(tage^2)", setdiff(covars, "tage"))
  rhs        <- paste(rhs_terms, collapse = " + ")
  ps_formula <- as.formula(paste0(treat_var, " ~ ", rhs))
  
  ps_model <- glm(
    ps_formula,
    data   = dat_complete,
    family = binomial(link = "logit")
  )
  
  e_hat <- predict(ps_model, type = "response")
  
 
  
  # 6. Outcome model for controls only: m0(x) = E[Y | T=0, X]
  outcome_rhs <- paste(covars, collapse = " + ")
  m0_formula  <- as.formula(paste0("y401k_ipw ~ ", outcome_rhs))
  
  m0_model <- glm(
    m0_formula,
    data   = dat_complete[Z == 0, ],
    family = gaussian()
  )
  
  m0_hat <- predict(m0_model, newdata = dat_complete, type = "response")
  
  # 7. Doubly robust ATT estimator
  # tau_ATT = (1/N1) * sum[ Z*(Y - m0) - (e/(1-e))*(1-Z)*(Y - m0) ]
  N      <- nrow(dat_complete)
  N1     <- sum(Z == 1)
  R0_hat <- Y - m0_hat
  
  tau_hat <- (1 / N1) * sum(
    Z * R0_hat -
      (e_hat / (1 - e_hat)) * (1 - Z) * R0_hat
  )
  
  # 8. Bootstrap SE and CI (using fixed nuisance estimates, like your ATE code)
  set.seed(seed)
  
  boot_ests <- replicate(B, {
    idx   <- sample(seq_len(N), replace = TRUE)
    Z_b   <- Z[idx]
    Y_b   <- Y[idx]
    e_b   <- e_hat[idx]
    m0_b  <- m0_hat[idx]
    R0_b  <- Y_b - m0_b
    N1_b  <- sum(Z_b == 1)
    
    # guard against (extremely unlikely) all-control resample
    if (N1_b == 0) return(NA_real_)
    
    sum(
      Z_b * R0_b -
        (e_b / (1 - e_b)) * (1 - Z_b) * R0_b
    ) / N1_b
  })
  
  boot_ests <- boot_ests[!is.na(boot_ests)]
  se_hat    <- sd(boot_ests)
  ci_95     <- tau_hat + c(-1, 1) * 1.96 * se_hat
  
  list(
    estimand    = "ATT",
    estimate    = tau_hat,
    se          = se_hat,
    ci_95       = ci_95,
    ps_model    = ps_model,
    # keep these names for compatibility, even though m1 is not used for ATT
    m1_model    = NULL,
    m0_model    = m0_model,
    e_hat       = e_hat,
    m1_hat      = NULL,
    m0_hat      = m0_hat,
    covariates  = covars,
    treat_var   = treat_var,
    outcome_var = outcome_var,
    n_obs       = N,
    boot_ests   = boot_ests,
    data_used   = dat_complete
  )
}

```
```{r}
# 1) Raw aligned
covars_raw_aligned <- c("tage", "hh_inc_year", "incmissing")

dr_raw_aligned <- run_dr_att(
  dat_raw_aligned_ipw,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_raw_aligned
)

dr_raw_aligned$estimate
dr_raw_aligned$se
dr_raw_aligned$ci_95


# 2) Raw non-restricted
covars_raw_non <- c(
  "tage", "hh_inc_year", "incmissing",
  "educ_cat", "firm_size_cat", "industry1d", "days_on_job"
)

dr_raw_non <- run_dr_att(
  dat_raw_ipw_non,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_raw_non
)

dr_raw_non$estimate
dr_raw_non$se
dr_raw_non$ci_95


# 3) Replication sample
covars_rep <- c(
  "tage", "hh_inc_year", "incmissing",
  "educ_cat", "firm_size_cat", "industry1d", "days_on_job"
)

dr_rep <- run_dr_att(
  dat_rep_ipw_rep,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_rep
)

dr_rep$estimate
dr_rep$se
dr_rep$ci_95

```
```{r}
dr_summary <- tibble::tibble(
  sample   = c("Raw aligned", "Raw non-restricted", "Replication"),
  method   = "DR AIPW (ATT)",
  estimate = c(dr_raw_aligned$estimate,
               dr_raw_non$estimate,
               dr_rep$estimate),
  se       = c(dr_raw_aligned$se,
               dr_raw_non$se,
               dr_rep$se),
  ci_lower = c(dr_raw_aligned$ci_95[1],
               dr_raw_non$ci_95[1],
               dr_rep$ci_95[1]),
  ci_upper = c(dr_raw_aligned$ci_95[2],
               dr_raw_non$ci_95[2],
               dr_rep$ci_95[2]),
  n_obs    = c(dr_raw_aligned$n_obs,
               dr_raw_non$n_obs,
               dr_rep$n_obs)
)

dr_summary

```