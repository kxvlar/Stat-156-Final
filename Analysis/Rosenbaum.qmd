---
title: "Rosenbaum"
format: html
---


```{r}

## Matching + Rosenbaum Sensitivity Script for 401(k) Data


## 0. Libraries
library(dplyr)
library(tidyr)
library(MatchIt)
library(rbounds)


## NOTE:
## This script assumes the following already exist in the environment:
## - dat_raw_aligned_ipw
## - dat_raw_ipw_non
## - dat_rep_ipw_rep
## - make_ipw_sample3()
## - make_ipw_outcome3()



## 1. Matching function that returns ATT + SE + CI + matched data


run_matching_att <- function(df,
                             outcome_var = "taltb",
                             treat_var   = "temp",
                             covars,
                             B    = 300,
                             seed = 156) {
  # 1. Main analysis sample (same as IPW)
  dat <- make_ipw_sample3(df)
  
  # 2. Build outcome (401k IPW outcome)
  dat$y401k_ipw <- make_ipw_outcome3(dat, outcome_var)
  
  # 3. Check covariates exist
  missing_covars <- setdiff(covars, names(dat))
  if (length(missing_covars) > 0) {
    stop(
      "These covariates are not in the data: ",
      paste(missing_covars, collapse = ", ")
    )
  }
  
  # 4. Filter to non-missing treatment, outcome, and covariates
  dat_complete <- dat %>%
    filter(
      !is.na(.data[[treat_var]]),
      !is.na(y401k_ipw)
    ) %>%
    tidyr::drop_na(all_of(covars))
  
  if (nrow(dat_complete) == 0) {
    stop(
      "After filtering for non-missing treatment, outcome, and covariates, ",
      "no observations remain. Check missingness again."
    )
  }
  
  # 5. Propensity score formula (always include age + age^2)
  rhs_terms <- c("tage", "I(tage^2)", setdiff(covars, "tage"))
  rhs       <- paste(rhs_terms, collapse = " + ")
  ps_formula <- as.formula(paste0(treat_var, " ~ ", rhs))
  
  # 6. Nearest neighbor matching on logit PS (ATT)
  m.out <- matchit(
    formula  = ps_formula,
    data     = dat_complete,
    method   = "nearest",
    distance = "logit",
    replace  = FALSE,
    ratio    = 1,
    estimand = "ATT"
  )
  
  matched_dat <- match.data(m.out)
  
  # 7. ATT point estimate on matched sample
  z <- matched_dat[[treat_var]]
  y <- matched_dat$y401k_ipw
  
  att_hat   <- mean(y[z == 1]) - mean(y[z == 0])
  n_treated <- sum(z == 1)
  n_control <- sum(z == 0)
  N         <- nrow(matched_dat)
  
  # 8. Bootstrap SE + CI
  set.seed(seed)
  boot_ests <- replicate(B, {
    idx      <- sample(seq_len(N), replace = TRUE)
    boot_dat <- matched_dat[idx, ]
    z_b      <- boot_dat[[treat_var]]
    y_b      <- boot_dat$y401k_ipw
    mean(y_b[z_b == 1]) - mean(y_b[z_b == 0])
  })
  
  se_hat <- sd(boot_ests)
  ci_95  <- att_hat + c(-1, 1) * 1.96 * se_hat
  
  # 9. Return everything useful
  list(
    estimate       = att_hat,
    se             = se_hat,
    ci_95          = ci_95,
    n_treated      = n_treated,
    n_control      = n_control,
    n_matched_rows = N,
    treat_var      = treat_var,
    covariates     = covars,
    m.out          = m.out,
    matched_data   = matched_dat,
    boot_ests      = boot_ests
  )
}



## 2. Rosenbaum sensitivity function (Hodges–Lehmann) 


rosenbaum_hl <- function(match_result, treat_var = "temp") {
  dat <- match_result$matched_data
  
  if (!"subclass" %in% names(dat)) {
    stop("Matched data must contain 'subclass' to identify matched pairs/sets.")
  }
  
  # For 1:1 matching, each subclass has 1 treated + 1 control
  dat_pairs <- dat %>%
    arrange(subclass, dplyr::desc(.data[[treat_var]])) %>%
    group_by(subclass) %>%
    summarise(
      y_treat = y401k_ipw[.data[[treat_var]] == 1],
      y_ctrl  = y401k_ipw[.data[[treat_var]] == 0],
      .groups = "drop"
    )
  
  # Rosenbaum bounds for Hodges–Lehmann estimate
  # x = treated outcomes, y = control outcomes
  hlsens(
    x        = dat_pairs$y_treat,
    y        = dat_pairs$y_ctrl,
    Gamma    = 2,     # max Gamma to check (change if needed)
    GammaInc = 0.1    # step size in Gamma grid
  )
}



## 3. Run matching on the three datasets 


## 3.1 Raw aligned
covars_raw_aligned <- c("tage", "hh_inc_year", "incmissing")

match_raw_aligned <- run_matching_att(
  dat_raw_aligned_ipw,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_raw_aligned
)

## 3.2 Raw non-restricted
covars_raw_non <- c(
  "tage", "hh_inc_year", "incmissing",
  "educ_cat", "firm_size_cat", "industry1d", "days_on_job"
)

match_raw_non <- run_matching_att(
  dat_raw_ipw_non,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_raw_non
)

## 3.3 Replication sample
covars_rep <- c(
  "tage", "hh_inc_year", "incmissing",
  "educ_cat", "firm_size_cat", "industry1d", "days_on_job"
)

match_rep <- run_matching_att(
  dat_rep_ipw_rep,
  outcome_var = "taltb",
  treat_var   = "temp",
  covars      = covars_rep
)



## 4. Summaries of matching estimates ----


matching_summary <- tibble::tibble(
  sample   = c("Raw aligned", "Raw non-restricted", "Replication"),
  estimate = c(match_raw_aligned$estimate,
               match_raw_non$estimate,
               match_rep$estimate),
  se       = c(match_raw_aligned$se,
               match_raw_non$se,
               match_rep$se),
  ci_lower = c(match_raw_aligned$ci_95[1],
               match_raw_non$ci_95[1],
               match_rep$ci_95[1]),
  ci_upper = c(match_raw_aligned$ci_95[2],
               match_raw_non$ci_95[2],
               match_rep$ci_95[2]),
  n_treat  = c(match_raw_aligned$n_treated,
               match_raw_non$n_treated,
               match_rep$n_treated),
  n_ctrl   = c(match_raw_aligned$n_control,
               match_raw_non$n_control,
               match_rep$n_control),
  n_rows   = c(match_raw_aligned$n_matched_rows,
               match_raw_non$n_matched_rows,
               match_rep$n_matched_rows)
)

matching_summary



## 5. Rosenbaum sensitivity for each matched sample


rosen_raw_aligned <- rosenbaum_hl(match_raw_aligned)
rosen_raw_non     <- rosenbaum_hl(match_raw_non)
rosen_rep         <- rosenbaum_hl(match_rep)

# Print results to inspect in console
rosen_raw_aligned
rosen_raw_non
rosen_rep



```